#include <OctoWS2811.h>
#include "math.h"
#include <ParticleEmitter.h>
// #include <Audio.h>
// #include <Wire.h>
// #include <SD.h>

#define HORI 41
#define VERT 8
#define MAX_RGB 128

const int ledsPerStrip = 41;
const int MIC_PIN = A3;

DMAMEM int displayMemory[ledsPerStrip*6];
int drawingMemory[ledsPerStrip*6];

const int config = WS2811_GRB | WS2811_800kHz;

OctoWS2811 leds(ledsPerStrip, displayMemory, drawingMemory, config);
// ParticleEmitter emitter = ParticleEmitter(leds.numPixels(), 0x999999);
ParticleEmitter emitter = ParticleEmitter(8 * 41);

void setup() {
  Serial.begin(9600);
  pinMode(MIC_PIN, INPUT);
  leds.begin();
  leds.show();
  Serial.print("Setup Done");
}

#define RED    0xFF0000
#define GREEN  0x00FF00
#define BLUE   0x0000FF
#define YELLOW 0xFFFF00
#define PINK   0xFF1088
#define ORANGE 0xE05800
#define WHITE  0xFFFFFF
#define LIGHT_WHITE 0x202020
#define PURPLE  0x4C0099
#define BLACK  0x000000
#define LIGHT_BLUE 0x0000A0

//Byte val 2PI Cosine Wave, offset by 1 PI 
//supports fast trig calcs and smooth LED fading/pulsing.
uint8_t const cos_wave[256] PROGMEM =  
{0,0,0,0,1,1,1,2,2,3,4,5,6,6,8,9,10,11,12,14,15,17,18,20,22,23,25,27,29,31,33,35,38,40,42,
45,47,49,52,54,57,60,62,65,68,71,73,76,79,82,85,88,91,94,97,100,103,106,109,113,116,119,
122,125,128,131,135,138,141,144,147,150,153,156,159,162,165,168,171,174,177,180,183,186,
189,191,194,197,199,202,204,207,209,212,214,216,218,221,223,225,227,229,231,232,234,236,
238,239,241,242,243,245,246,247,248,249,250,251,252,252,253,253,254,254,255,255,255,255,
255,255,255,255,254,254,253,253,252,252,251,250,249,248,247,246,245,243,242,241,239,238,
236,234,232,231,229,227,225,223,221,218,216,214,212,209,207,204,202,199,197,194,191,189,
186,183,180,177,174,171,168,165,162,159,156,153,150,147,144,141,138,135,131,128,125,122,
119,116,113,109,106,103,100,97,94,91,88,85,82,79,76,73,71,68,65,62,60,57,54,52,49,47,45,
42,40,38,35,33,31,29,27,25,23,22,20,18,17,15,14,12,11,10,9,8,6,6,5,4,3,2,2,1,1,1,0,0,0,0
};


//Gamma Correction Curve
uint8_t const exp_gamma[256] PROGMEM =
{0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,3,3,3,3,3,
4,4,4,4,4,5,5,5,5,5,6,6,6,7,7,7,7,8,8,8,9,9,9,10,10,10,11,11,12,12,12,13,13,14,14,14,15,15,
16,16,17,17,18,18,19,19,20,20,21,21,22,23,23,24,24,25,26,26,27,28,28,29,30,30,31,32,32,33,
34,35,35,36,37,38,39,39,40,41,42,43,44,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,
61,62,63,64,65,66,67,68,70,71,72,73,74,75,77,78,79,80,82,83,84,85,87,89,91,92,93,95,96,98,
99,100,101,102,105,106,108,109,111,112,114,115,117,118,120,121,123,125,126,128,130,131,133,
135,136,138,140,142,143,145,147,149,151,152,154,156,158,160,162,164,165,167,169,171,173,175,
177,179,181,183,185,187,190,192,194,196,198,200,202,204,207,209,211,213,216,218,220,222,225,
227,229,232,234,236,239,241,244,246,249,251,253,254,255
};


uint8_t invader2_1[192] PROGMEM = {0,0,0, 0,0,0, 0,0,0, 255,255,255, 255,255,255, 0,0,0, 0,0,0, 0,0,0, 
                                   0,0,0, 0,0,0, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 0,0,0, 0,0,0, 
                                   0,0,0, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 0,0,0, 
                                   255,255,255, 255,255,255, 255,0,0, 255,255,255, 255,255,255, 255,0,0, 255,255,255, 255,255,255,
                                   255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 
                                   0,0,0, 0,0,0, 255,255,255, 0,0,0, 0,0,0, 255,255,255, 0,0,0, 0,0,0, 
                                   0,0,0, 255,255,255, 0,0,0, 255,255,255, 255,255,255, 0,0,0, 255,255,255, 0,0,0, 
                                   255,255,255, 0,0,0, 255,255,255, 0,0,0, 0,0,0, 255,255,255, 0,0,0, 255,255,255};
uint8_t invader2_1_w = 8;
uint8_t invader2_1_h = 8;

uint8_t invader2_2[192] PROGMEM = {0,0,0, 0,0,0, 0,0,0, 255,255,255, 255,255,255, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 0,0,0, 0,0,0, 0,0,0, 255,255,255, 255,255,255, 254,254,254, 254,254,254, 255,255,255, 255,255,255, 0,0,0, 255,255,255, 255,255,255, 0,255,0, 255,255,255, 255,255,255, 0,255,0, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 0,0,0, 0,0,0, 255,255,255, 0,0,0, 0,0,0, 255,255,255, 0,0,0, 0,0,0, 15,15,15, 255,255,255, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 255,255,255, 0,0,0, 0,0,0, 0,0,0, 255,255,255, 15,15,15, 0,0,0, 255,255,255, 0,0,0, 0,0,0};
uint8_t invader2_2_w = 8;
uint8_t invader2_2_h = 8;

uint8_t invader3_1[288] PROGMEM = {0,0,0, 0,0,0, 0,0,0, 0,0,0, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 0,0,0, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 0,0,255, 0,0,255, 255,255,255, 255,255,255, 0,0,255, 0,0,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 0,0,0, 0,0,0, 0,0,0, 255,255,255, 255,255,255, 0,0,0, 0,0,0, 255,255,255, 255,255,255, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 15,15,15, 255,255,255, 0,0,0, 0,0,0, 255,255,255, 255,255,255, 0,0,0, 0,0,0, 255,255,255, 15,15,15, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 255,255,255, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 255,255,255, 0,0,0, 0,0,0, 0,0,0};
uint8_t invader3_1_w = 12;
uint8_t invader3_1_h = 8;

uint8_t invader3_2[288] PROGMEM = {0,0,0, 0,0,0, 0,0,0, 0,0,0, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 0,0,0, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,0,0, 255,0,0, 255,255,255, 255,255,255, 255,0,0, 255,0,0, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 255,255,255, 0,0,0, 0,0,0, 0,0,0, 252,252,252, 255,255,255, 0,0,0, 0,0,0, 255,255,255, 255,255,255, 0,0,0, 0,0,0, 0,0,0, 17,17,17, 32,32,32, 255,255,255, 255,255,255, 0,0,0, 255,255,255, 255,255,255, 0,0,0, 255,255,255, 255,255,255, 0,0,0, 0,0,0, 255,255,255, 255,255,255, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 255,255,255, 255,255,255};
uint8_t invader3_2_w = 12;
uint8_t invader3_2_h = 8;

uint8_t timbers_axe[360] PROGMEM = {9,73,19, 8,73,19, 8,73,19, 8,73,19, 8,73,19, 8,73,19, 8,73,19, 8,73,19, 8,73,19, 8,73,19, 8,73,19, 8,73,19, 8,73,19, 8,73,19, 10,74,20, 76,119,37, 204,204,67, 142,163,52, 92,130,40, 54,104,31, 30,88,25, 16,78,23, 11,75,21, 15,77,22, 28,86,25, 53,103,31, 88,127,39, 137,160,51, 199,201,66, 90,128,40, 144,165,53, 239,228,74, 239,228,74, 239,228,74, 239,228,74, 239,228,74, 239,228,74, 239,228,74, 239,228,74, 239,228,74, 239,228,74, 239,228,74, 239,228,74, 239,228,74, 153,170,54, 175,185,60, 239,228,74, 239,228,74, 239,228,74, 239,228,74, 239,228,74, 239,228,74, 239,228,74, 239,228,74, 239,228,74, 239,228,74, 239,228,74, 239,228,74, 239,228,74, 181,189,61, 168,180,59, 239,228,74, 239,228,74, 239,228,74, 239,228,74, 239,228,74, 239,228,74, 239,228,74, 239,228,74, 239,228,74, 239,228,74, 239,228,74, 239,228,74, 239,228,74, 177,187,61, 127,153,49, 239,228,74, 237,226,74, 186,192,63, 132,156,50, 97,133,42, 74,118,36, 71,116,37, 73,117,35, 95,131,41, 128,154,49, 179,188,61, 234,225,73, 239,228,74, 141,162,52, 52,103,33, 124,151,48, 31,89,26, 8,73,19, 8,73,19, 8,73,19, 145,165,53, 239,228,74, 181,189,62, 8,73,19, 8,73,19, 8,73,19, 26,85,24, 114,144,46, 64,111,34, 8,73,19, 8,73,19, 8,73,19, 8,73,19, 8,73,19, 8,73,19, 125,151,48, 239,228,74, 164,177,58, 8,73,19, 8,73,19, 8,73,19, 8,73,19, 8,73,19, 8,73,19};
uint8_t timbers_axe_w = 15;
uint8_t timbers_axe_h = 8;

uint8_t timbers_axe2[408] PROGMEM = {1,71,17, 45,103,14, 38,97,15, 1,71,17, 1,71,17, 1,71,17, 1,71,17, 1,71,17, 1,71,17, 1,71,17, 1,71,17, 1,71,17, 1,71,17, 8,76,17, 71,122,12, 9,77,16, 1,71,17, 2,72,17, 181,201,5, 255,255,0, 226,234,2, 175,197,5, 136,169,8, 109,149,10, 94,138,11, 90,135,11, 97,141,11, 117,155,9, 149,178,7, 194,211,4, 245,248,1, 255,255,0, 81,129,12, 1,71,17, 1,71,17, 234,240,1, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 134,168,8, 1,71,17, 1,71,17, 250,251,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 152,180,7, 1,71,17, 1,71,17, 231,238,2, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 254,254,0, 243,247,1, 238,242,1, 248,250,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 136,169,8, 1,71,17, 1,71,17, 181,201,5, 244,247,1, 164,189,6, 93,138,11, 42,101,14, 9,76,16, 76,126,12, 87,133,12, 49,106,14, 18,84,16, 59,113,13, 117,155,9, 198,213,4, 255,255,0, 83,131,11, 1,71,17, 1,71,17, 47,104,14, 19,84,16, 1,71,17, 1,71,17, 2,71,17, 3,72,17, 214,226,3, 255,255,0, 131,165,8, 2,71,17, 1,71,17, 1,71,17, 1,71,17, 55,110,13, 11,78,16, 1,71,17, 1,71,17, 2,71,17, 1,71,17, 1,71,17, 2,71,17, 2,72,17, 1,71,17, 191,208,4, 255,255,0, 107,148,10, 1,71,17, 1,71,17, 1,71,17, 1,71,17, 1,71,17, 1,71,17, 1,71,17};
uint8_t timbers_axe2_w = 17;
uint8_t timbers_axe2_h = 8;

uint8_t rctid[1008] PROGMEM = {0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 68,68,0, 221,221,0, 255,255,0, 255,255,0, 255,255,0, 119,119,0, 0,0,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 0,0,0, 119,119,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 136,136,0, 0,0,0, 238,238,0, 255,255,0, 255,255,0, 204,204,0, 51,51,0, 0,0,0, 0,0,0, 102,102,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 187,187,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 34,34,0, 255,255,0, 119,119,0, 0,0,0, 68,68,0, 221,221,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 255,255,0, 34,34,0, 0,0,0, 0,0,0, 136,136,0, 119,119,0, 0,0,0, 255,255,0, 0,0,0, 119,119,0, 153,153,0, 0,0,0, 221,221,0, 34,34,0, 0,0,0, 119,119,0, 238,238,0, 34,34,0, 17,17,0, 238,238,0, 51,51,0, 0,0,0, 102,102,0, 187,187,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 119,119,0, 170,170,0, 0,0,0, 0,0,0, 68,68,0, 221,221,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 255,255,0, 34,34,0, 0,0,0, 0,0,0, 153,153,0, 119,119,0, 0,0,0, 255,255,0, 0,0,0, 119,119,0, 153,153,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 170,170,0, 119,119,0, 17,17,0, 255,255,0, 51,51,0, 0,0,0, 102,102,0, 187,187,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 153,153,0, 119,119,0, 0,0,0, 0,0,0, 68,68,0, 221,221,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 255,255,0, 34,34,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 255,255,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 119,119,0, 153,153,0, 0,0,0, 102,102,0, 255,255,0, 255,255,0, 255,255,0, 187,187,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 119,119,0, 170,170,0, 0,0,0, 0,0,0, 68,68,0, 221,221,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 255,255,0, 34,34,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 255,255,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 170,170,0, 119,119,0, 0,0,0, 51,51,0, 255,255,0, 51,51,0, 102,102,0, 187,187,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 34,34,0, 255,255,0, 119,119,0, 0,0,0, 68,68,0, 221,221,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 255,255,0, 34,34,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 255,255,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 221,221,0, 68,68,0, 0,0,0, 102,102,0, 238,238,0, 34,34,0, 0,0,0, 221,221,0, 119,119,0, 0,0,0, 102,102,0, 187,187,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 68,68,0, 221,221,0, 255,255,0, 255,255,0, 255,255,0, 119,119,0, 0,0,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 0,0,0, 0,0,0, 0,0,0, 255,255,0, 255,255,0, 255,255,0, 0,0,0, 0,0,0, 0,0,0, 119,119,0, 255,255,0, 255,255,0, 221,221,0, 68,68,0, 0,0,0, 0,0,0, 204,204,0, 0,0,0, 0,0,0, 255,255,0, 255,255,0, 187,187,0, 0,0,0, 0,0,0, 0,0,0};
uint8_t rctid_w = 42;
uint8_t rctid_h = 8;

uint8_t pac1[192] PROGMEM = {0,0,0, 0,0,0, 0,0,0, 0,0,0, 77,77,13, 68,68,13, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 75,75,0, 222,222,0, 255,255,0, 255,255,0, 63,63,0, 0,0,0, 0,0,0, 0,0,0, 255,255,0, 255,255,0, 255,255,0, 124,124,0, 0,0,0, 0,0,0, 0,0,0, 127,127,0, 255,255,0, 252,252,0, 102,102,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 146,146,0, 255,255,0, 251,251,0, 62,62,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 42,42,0, 255,255,0, 255,255,0, 254,254,0, 76,76,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 113,113,0, 255,255,0, 255,255,0, 255,255,0, 64,64,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 59,59,13, 134,134,13, 130,130,13, 0,0,0, 0,0,0};
uint8_t pac1_w = 8;
uint8_t pac1_h = 8;

uint8_t pac2[192] PROGMEM = {0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 59,59,0, 194,194,0, 242,242,0, 190,190,0, 70,70,0, 0,0,0, 0,0,0, 48,48,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 235,235,0, 0,0,0, 0,0,0, 138,138,0, 255,255,0, 252,252,0, 159,159,0, 62,62,0, 21,21,0, 0,0,0, 0,0,0, 144,144,0, 255,255,0, 251,251,0, 131,131,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 67,67,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 215,215,0, 0,0,0, 0,0,0, 0,0,0, 101,101,0, 239,239,0, 255,255,0, 242,242,0, 127,127,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0};
uint8_t pac2_w = 8;
uint8_t pac2_h = 8;

uint8_t pac3[192] PROGMEM = {0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 88,88,0, 216,216,0, 242,242,0, 166,166,0, 20,20,0, 0,0,0, 0,0,0, 73,73,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 221,221,0, 0,0,0, 0,0,0, 197,197,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 78,78,13, 0,0,0, 203,203,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 84,84,13, 0,0,0, 102,102,0, 255,255,0, 255,255,0, 255,255,0, 255,255,0, 251,251,0, 34,34,13, 0,0,0, 0,0,0, 138,138,0, 251,251,0, 255,255,0, 219,219,0, 51,51,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0};
uint8_t pac3_w = 8;
uint8_t pac3_h = 8;

uint8_t rsl[1008] PROGMEM = {0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 102,0,0, 255,0,0, 255,0,0, 255,0,0, 187,0,0, 0,0,0, 0,0,0, 255,0,0, 255,0,0, 255,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 238,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 187,0,0, 102,0,0, 0,0,0, 0,0,0, 221,0,0, 119,0,0, 0,0,0, 51,0,0, 238,0,0, 51,0,0, 0,0,0, 238,0,0, 85,0,0, 0,0,0, 34,0,0, 255,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 187,0,0, 102,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 34,0,0, 221,0,0, 68,0,0, 0,0,0, 238,0,0, 85,0,0, 0,0,0, 34,0,0, 255,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 187,0,0, 102,0,0, 0,0,0, 0,0,0, 119,0,0, 238,0,0, 255,0,0, 221,0,0, 119,0,0, 0,0,0, 0,0,0, 102,0,0, 238,0,0, 255,0,0, 255,0,0, 255,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 187,0,0, 102,0,0, 0,0,0, 17,0,0, 255,0,0, 51,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 34,0,0, 238,0,0, 68,0,0, 34,0,0, 255,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 187,0,0, 68,0,0, 0,0,0, 0,0,0, 187,0,0, 102,0,0, 0,0,0, 17,0,0, 255,0,0, 68,0,0, 0,0,0, 17,0,0, 204,0,0, 0,0,0, 0,0,0, 204,0,0, 136,0,0, 0,0,0, 34,0,0, 255,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 187,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 255,0,0, 187,0,0, 0,0,0, 0,0,0, 238,0,0, 255,0,0, 255,0,0, 221,0,0, 0,0,0, 0,0,0, 204,0,0, 0,0,0, 0,0,0, 187,0,0, 255,0,0, 255,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0};
uint8_t rsl_w = 42;
uint8_t rsl_h = 8;



void setAllOff(bool show)
{
  for(int i=0; i<HORI; i++)
  {
    for(int j=0; j<VERT; j++)
    {
      leds.setPixel(getPixelAddress(j,i), colorFromRGB(0,0,0));
    }
  }
  if(show)
    leds.show();
}

void spaceInvaders()
{
  int i = 0;
  // for(int i=0; i<HORI; i++)
  while(true)
  {
    setBitmap(invader3_1, invader3_1_h, invader3_1_w, i, false);
    // setBitmap(invader3_1, invader3_1_h, invader3_1_w, i + 24, false);
    leds.show();
    delay(200);
    setAllOff(false);
    i++;

    setBitmap(invader3_2, invader3_2_h, invader3_2_w, i, false);
    // setBitmap(invader3_1, invader3_1_h, invader3_1_w, i + 24, false);
    leds.show();
    delay(200);
    setAllOff(false);
    i++;

    // setBitmap(invader2_2, invader2_2_h, invader2_2_w, i, false);
    // // setBitmap(invader3_2, invader3_2_h, invader3_2_w, i + 24, false);
    // leds.show();
    // delay(500);
    // setAllOff();
    // i++;
    if(i > (HORI * 2) + (invader3_1_w * 4))
      i = 0;
  }
}

void setBitmap(uint8_t* bmp, int height, int width, int upperLeft, bool show)
{
  int index = 0;
  
  for(int y=0; y<height; y++)
  {
    for(int x=upperLeft; x<(upperLeft + (width * 3)); x+=3)
    {
      int addr;
      int realx = x / 3;
      addr = getPixelAddress(y,realx);
      int r = bmp[index + 0];
      int g = bmp[index + 1];
      int b = bmp[index + 2];
      leds.setPixel(addr, colorFromRGB(r, g, b));
      index += 3;
    }
    
  }
  if(show)
    leds.show();
}

void timbers()
{
  // setBitmap(timbers_axe2, timbers_axe2_h, timbers_axe2_w, HORI - (timbers_axe_w / 2), true);
  // delay(10000);
  for(int i=-120; i<0; i++)
  {
    delay(30);
    setBitmap(rctid, rctid_h, rctid_w, i, true);
  }
  delay(5000);

   
  setAllOff(true);
  setBitmap(timbers_axe2, timbers_axe2_h, timbers_axe2_w, HORI - (timbers_axe_w / 2), true);
  delay(10000);
  setAllOff(true);
}

void pac()
{
  setBitmap(rsl, rsl_h, rsl_w, 0, true);
  for(int i=0; i<100; i+=3)
  {
    setBitmap(pac1, pac1_h, pac1_w, i, true);
    delay(100);
    setBitmap(pac2, pac2_h, pac2_w, i+1, true);
    delay(100);
    setBitmap(pac3, pac3_h, pac3_w, i+2, true);
    delay(100);
  }
}

void loop() 
{
  pac();
  delay(1000);
  timbers();

  // spaceInvaders();

   // int microsec = 2000000 / leds.numPixels(); 
  // int mic_val = analogRead(MIC_PIN);
  // Serial.print("mic_val: ");
  // Serial.println(mic_val);
  // delay(100);

  // uncomment for voltage controlled speed
  // millisec = analogRead(A9) / 40;

  // colorWipe(RED, microsec);
  // colorWipe(GREEN, microsec);
  // colorWipe(BLUE, microsec);
  // colorWipe(YELLOW, microsec);
  // colorWipe(PINK, microsec);
  // colorWipe(ORANGE, microsec);
  // colorWipe(WHITE, microsec);

  // plasma();

  // for(int i=0; i<200; i++)
  // {
  //   sparkle(BLACK, PURPLE);
  //   delay(30);
  // }

  // for(int i=0; i<10; i++)
  // {
  //   colorfulWipe();
  // }

  // rainbowCycle(5);

  // for(int i=0; i<200; i++)
  // {
  //   followMe();
  // }

  // setAll(BLACK);

  // for(int i=0; i<2; i++)
  // {
  //    particles();
  // }

  // for(int i=0; i<200; i++)
  // {
  //   sparkle(BLACK, GREEN);
  //   delay(30);
  // }
}

void colorfulWipe()
{

  uint32_t color = colorFromRGB(random(50), random(50), random(50));
  for(int i=0; i<leds.numPixels(); i++)
  {
    leds.setPixel(i, color);
    leds.show();
     delay(8);
  }

  for(int i=leds.numPixels(); i>=0; i--)
  {
    leds.setPixel(i, BLACK);
    leds.show();
    // delay(8);
  }
}

void rainbowCycle(uint8_t wait) {
  uint16_t i, j;

  for(j=0; j<256*5; j++) { // 5 cycles of all colors on wheel
    for(i=0; i< leds.numPixels(); i++) {
      leds.setPixel(i, Wheel(((i * 256 / leds.numPixels()) + j) & 255));
    }
    leds.show();
    delay(wait);
  }
}

void followMe()
{
  int MAX_VAL = 56;
  uint32_t time = millis();
  // Serial.print("time:");
  // Serial.println(time);
  for (int pixel = 0; pixel < HORI * VERT; pixel++)
  {
      float t = pixel * 0.2 + time * 0.002;
      uint32_t red = (MAX_VAL + 96 * sin(t + 0.8)) / 10;
      uint32_t green = (MAX_VAL + 96 * sin(t + 0.6)) / 10;
      uint32_t blue = (MAX_VAL + 96 * sin(t + 0.1)) / 10;
      uint32_t color = colorFromRGB(red, green, blue);
      Serial.print("color:");
      Serial.println(color);

      leds.setPixel(pixel, colorFromRGB(red, green, blue));
  }
  leds.show();
  delay(10);
}

void colorWipe(int color, int wait)
{
  for(int i=0; i<VERT; i++)
  {
    for(int j=0; j<HORI; j++)
    {
      int addr = getPixelAddress(i, j);
      Serial.println(addr);

      leds.setPixel(addr, color);
      leds.show();
      delayMicroseconds(wait);
    }
  }
  // for(int i=0; i<VERT * HORI; i++)
  // {
  //   leds.setPixel(i, color);
  //   leds.show();
  //   delayMicroseconds(wait);
  // }
}

void sparkle(uint32_t c, uint32_t c2)
{
  setAll(c);
  for(int i=0; i<10; i++)
  {
    int addr = random(VERT * HORI);
    leds.setPixel(addr, c2);
  }
  leds.show();
}

void setAll(uint32_t c)
{
  for(int i=0; i<HORI; i++)
  {
    setCol(c, i);
  }
  leds.show();
}

void setCol(uint32_t c, uint8_t col)
{
  for(int i=0; i<VERT; i++)
  { 
    int addr = getPixelAddress(i, col);  
    leds.setPixel(addr, c);
  }
}

void particles() {
  emitter.stripPosition = random(100) / 100.0;

  for (int j=0; j < emitter.numParticles * 10; j++) {  
    
    for (int i=0; i < emitter.numParticles; i++) {
      
      particle prt = emitter.updateParticle(i);
      uint16_t pixel = leds.numPixels() * prt.currentStripPosition;
  
      // High velocity particles have longer tails
      uint8_t tailLength = abs(prt.velocity * 5);
      uint8_t slot = pixel;
      
      for (int z=0; z < tailLength; z++) { 
        
        float colorScale = ( (tailLength-z*0.999) / tailLength );
        if (z == 0 && prt.dimmed) {
          colorScale *= 0.25;
        }

        leds.setPixel(slot, colorFromRGB(prt.redColor*colorScale, 
                                              prt.blueColor*colorScale, 
                                              prt.greenColor*colorScale));

        slot = pixel + ((z+1) * (prt.velocity > 0 ? -1 : 1));
      }
      leds.setPixel(slot, colorFromRGB(0,0,0));
    }
    leds.show();
    delay(50);
  }
}

void plasma()
{
  unsigned long frameCount=25500;  // arbitrary seed to calculate the three time displacement variables t,t2,t3
  for(int i=0; i<1000; i++) {
    frameCount++ ; 
    uint16_t t = fastCosineCalc((42 * frameCount)/100);  //time displacement - fiddle with these til it looks good...
    uint16_t t2 = fastCosineCalc((35 * frameCount)/100); 
    uint16_t t3 = fastCosineCalc((38 * frameCount)/100);

    for (uint8_t y = 0; y < VERT; y++) {
      int left2Right, pixelIndex;
      if (((y % (VERT/8)) & 1) == 0) {
        left2Right = 1;
        pixelIndex = y * HORI;
      } else {
        left2Right = -1;
        pixelIndex = (y + 1) * HORI - 1;
      }
      for (uint8_t x = 0; x < HORI ; x++) {
        //Calculate 3 seperate plasma waves, one for each color channel
        uint8_t r = fastCosineCalc(((x << 3) + (t >> 1) + fastCosineCalc((t2 + (y << 3))))) / 10;
        uint8_t g = fastCosineCalc(((y << 3) + t + fastCosineCalc(((t3 >> 2) + (x << 3))))) / 10;
        uint8_t b = fastCosineCalc(((y << 3) + t2 + fastCosineCalc((t + x + (g >> 2))))) / 10;
        //uncomment the following to enable gamma correction
        //r=pgm_read_byte_near(exp_gamma+r);  
        //g=pgm_read_byte_near(exp_gamma+g);
        //b=pgm_read_byte_near(exp_gamma+b);
        leds.setPixel(pixelIndex, ((r << 16) | (g << 8) | b));
        pixelIndex += left2Right;
      }
    }
    digitalWrite(13, HIGH);
    leds.show();  // not sure if this function is needed  to update each frame
    delay(8);
    digitalWrite(13, LOW);
  }
}

void setPixels(uint8_t pixels[][8][3], int size_x, int size_y, int row, int start_col)
{
  for(int x=0; x<size_x; x++)
  {
    int col = x + start_col;
    if(col > HORI)
      continue;
    for(int y=0; y<size_y; y++)
    {
      int addr = getPixelAddress(x, y);
      leds.setPixel(addr, colorFromRGB(pixels[x][y][0], 
                          pixels[x][y][1], 
                          pixels[x][y][2]));
    }
  }
}

inline uint8_t fastCosineCalc( uint16_t preWrapVal)
{
  uint8_t wrapVal = (preWrapVal % 255);
  if (wrapVal<0) wrapVal=255+wrapVal;
  return (pgm_read_byte_near(cos_wave+wrapVal)); 
}

int getPixelAddress(int row, int col)
{
  return (row * HORI) + col;

  // int addr;
  // if(row % 2 == 0)
  // {
  //   addr = (row * HORI) + col;
  // }
  // else
  // {
  //   int offset = HORI - ((col * 2) + 1) ;
  //   addr = ((row * HORI) + col) + offset;
  // }
  // return addr;
}

uint32_t Wheel(byte WheelPos) {
  if(WheelPos < 85) {
   return colorFromRGB(WheelPos * 3, 255 - WheelPos * 3, 0);
  } else if(WheelPos < 170) {
   WheelPos -= 85;
   return colorFromRGB(255 - WheelPos * 3, 0, WheelPos * 3);
  } else {
   WheelPos -= 170;
   return colorFromRGB(0, WheelPos * 3, 255 - WheelPos * 3);
  }
}

uint32_t colorFromRGB(int red, int green, int blue)
{
  uint32_t color = red<<16 | green<<8 | blue;
  return color;
}
